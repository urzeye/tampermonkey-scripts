# Changelog

## 版本 1.9.9 (2025-12-25)

### ✨ 新功能

- **通知声音音量控制**：在「标签页设置」中新增声音音量滑块（10%-100%），可自定义通知提示音的音量大小。
  - 仅在开启「通知声音」时可用，否则自动置灰
- **前台时也通知**：新增开关，控制当页面在前台可见时是否也发送通知。
  - 默认关闭，开启后即使用户在当前页面也会收到通知

### 🐛 Bug 修复

- **修复面板拖拽跳动问题**：页面刷新后首次拖拽面板时，不再出现向下跳动半屏的现象。
  - **根因分析**：CSS 使用 `top: 50%` + `translateY(-50%)` 实现垂直居中，但拖拽时用 `translate(x, y)` 覆盖了原有的 `-50%` 偏移
  - **解决方案**：
    1. 重写 `makeDraggable`：在 `mousedown` 时用 `getBoundingClientRect()` 读取实际位置，切换为 `left/top` 定位
    2. CSS 精细化过渡：将 `transition: all` 改为 `transition: box-shadow, border-color`，避免定位属性参与过渡动画导致抖动
    3. 窗口边界检测：监听 `resize` 事件，确保拖拽过的面板始终在视口内可见（collapsed 状态跳过检测）

## 版本 1.9.8 (2025-12-24)

### 🐛 Bug 修复

- **增强 Markdown 加粗修复**：修复跨节点 `**加粗**` 渲染异常问题。
  - 当 `**` 被 `<b>` 标签分隔时（如 `**文本<b>中间</b>文本**`），现在能正确拆分为独立的 `<strong>` 块
  - 先将 `<b>` 展开为 `**`，再统一转换为 `<strong>`
  - 使用 DOM API 操作，无需 Trusted Types Policy

## 版本 1.9.7 (2025-12-24)

### 🐛 Bug 修复

- **修复生成完成通知误发**：用户在前台看完 AI 回复后切换页面，不再收到多余的"生成完成"通知。
  - 新增 `visibilitychange` 事件监听，追踪用户是否在前台看到过完成状态
  - 只有用户真正在后台等待生成完成时才发送通知

## 版本 1.9.6 (2025-12-23)

### ✨ 新功能

- **去顶部加载全部历史**：点击「去顶部」按钮时，自动加载全部历史记录并滚动到真正的顶部。
  - 采用延迟遮罩策略：短对话（< 1 秒）无遮罩，长对话自动显示加载界面
  - 支持停止加载：加载过程中可随时中止
  - 点击去底部或锚点按钮会自动取消进行中的加载
  - 超时保护：最多 40 秒自动完成，防止无限循环
  - 适配 Gemini 标准版和企业版（包括 Shadow DOM）

### 🐛 Bug 修复

- **修复阅读历史不更新**：会话切换后滚动位置不再被记录的问题。根因是 DOM 重新渲染后旧滚动容器被销毁，但监听未重新绑定。现在使用
  `restartRecording()` 确保每次会话切换都重新绑定监听。
- **修复 Gemini Business 滚动容器定位**：点击「同步会话」后，「去顶部/底部」按钮错误滚动侧边栏的问题。现在使用
  `.chat-mode-scroller` 精确选择器定位主内容区。
- 恢复被误删的GM_notification

## 版本 1.9.5 (2025-12-23)

### ✨ 新功能

- **Markdown 加粗修复**：自动修复 Gemini 普通版响应中未正确渲染的 `**加粗**` 语法（仅标准版需要，企业版无此问题）。
  - 使用 DOM API 操作，不使用 innerHTML，性能更优
  - 保护 `<code>`/`<pre>` 代码块，避免误修复
  - 通过 `data-original-markdown` 属性保留原始格式，支持未来导出功能
  - 可在「面板设置」中开关，默认开启

## 版本 1.9.4 (2025-12-23)

### ✨ 新功能

- **云端置顶同步**：Gemini 标准版中原网页 pinned 的会话，同步到"会话"Tab 时会自动保持置顶状态。
- **会话设置面板**：新增"会话设置"手风琴区域（位于设置 Tab），支持配置：
  - **同步时更新取消置顶**：手动同步时将云端未置顶的会话在本地也取消置顶（默认关闭）。

### 🐛 Bug 修复

- **修复输入框深色模式样式**：修复主题切换后，所有输入框（搜索框、表单输入框、自定义图标输入框等）在深色模式下仍显示白色背景的问题。
- **修复 Pin 状态自动同步**：修复了在侧边栏手动置顶/取消置顶会话时，本地列表未能实时同步状态的问题。

### 🎨 UI 优化

- **深色模式 Tab 标题样式**：优化面板 Tab 栏在深色模式下的激活状态显示，添加顶部高亮边框，视觉效果更协调。

## 版本 1.9.3 (2025-12-22)

### ✨ Features (UI Enhancement)

- **主题切换动画**：新增圆形扩散动画效果，使用 View Transitions API，从点击位置开始扩散/收缩。
- **折叠面板按钮排序**：在"面板设置"中新增按钮排序功能，可自定义折叠面板的 5 个快捷按钮顺序（顶部/面板/锚点/主题/底部）。
- **锚点/主题按钮开关**：锚点和主题按钮支持独立的显示/隐藏开关。

### 🔧 其他改进

- 移除了对 Genspark 的支持，专注于 Gemini 生态。

## 版本 1.9.2 (2025-12-21)

### ✨ Features (Panel Settings)

- **面板可见性控制**: 新增“面板设置”区域，支持自定义面板行为。
  - **默认显示状态**: 可设置刷新页面后面板默认展开或折叠。
  - **自动隐藏**: 支持点击面板外部自动收起面板，减少干扰。
  - **折叠锚点**: 在面板折叠状态下显示/隐藏悬浮锚点按钮。
- **设置重构**: 新增独立的“面板设置”手风琴区域，交互类设置更加集中。

## 版本 1.9.1 (2025-12-21)

### ✨ Features (Auto Dark Mode)

- **全自动暗色模式适配**: 完美支持 Gemini 的深色主题，告别刺眼白屏！
  - **🌓 智能检测**: 实时监听系统/网页主题变化，毫秒级自动切换 UI 风格。
  - **🎨 语义化配色**: 重构全站 CSS 变量，确保面板、弹窗、文件夹、标签等所有元素在深色模式下色彩和谐、对比度适宜。
  - **👁️ 细节打磨**:
    - 为深色模式下的操作按钮添加精致的半透明边框，提升可视性。
    - 优化悬浮提示 (Tooltip) 对比度，确保文字清晰可读。
    - 适配文件夹背景色，在深色模式下呈现柔和的半透明效果。

## 版本 1.9.0 (2025-12-21)

### ✨ Features (New Conversations Tab)

- **会话高级管理 (Advanced Conversation Management)**: 新增独立的“会话”面板，提供强大的会话组织能力。
  - **📁 文件夹系统 (Folders)**: 支持创建自定义文件夹，拖拽归档会话，通过右键或批量操作管理。
  - **🏷️ 标签系统 (Tags)**: 内置 30 种中国传统色标签，支持自定义 HEX 颜色，支持多标签筛选与管理。
  - **🔍 实时搜索 (Search)**: 支持按标题实时过滤会话列表，结合标签筛选精准定位。
  - **📌 批量操作 (Batch Actions)**: 支持多选会话进行批量删除、移动文件夹。
  - **📌 快捷操作**: 支持置顶会话、重命名、归档等常用操作。
- **无缝同步**: 自动同步 Gemini 侧边栏的最新会话数据（标准版与 Business 版全兼容）。

## 版本 1.8.2 (2025-12-20)

### 🐛 Bug Fixes

- 修复 Gemini Business 版会话同步失效的问题。
- 修复 `monitorConversationTitle` 的 Shadow DOM 兼容性。

## 版本 1.8.1 (2025-12-16)

> **Bug 修复版本**：修复标签页功能的多个问题，包括标题污染、重复通知、后台状态检测等。

### 🐛 Bug 修复

- **修复标题被污染**：防止模型名称、状态图标、隐私模式标题被错误缓存到会话名称中
- **修复重复通知**：生成完成时不再发送两次通知
- **修复后台状态检测**：Gemini 普通版后台生成完成后，状态图标现在能立即更新
- **修复分类标签不更新**：删除某个分类的最后一个提示词后，现在会正确移除该分类标签
- **修复界面排版调整后按钮失效**：调整 Tab 顺序后，"添加提示词"按钮和悬浮条"清除"按钮现在能正常响应点击

### 🔧 技术改进

- **NetworkMonitor 始终运行**：改为始终监控网络请求，确保能捕捉到在前台发起的请求
- **AI 状态机重构**：使用 `_aiState`（idle / generating / completed）替代多个布尔标志，代码更清晰
- **移除 batchexecute 监控**：该通用 RPC 方法会频繁调用导致误判，已从监控列表中移除

---

## 版本 1.8.0 (2025-12-16)

> **标签页增强**：本版本为标签页功能带来全面升级，包括生成状态感知、隐私模式、自定义标题格式等多项新特性。

### ✨ 标签页标题增强

- **生成状态显示**：标签页标题前自动显示 ⏳（生成中）或 ✅（完成）状态图标。
- **自定义标题格式**：支持使用占位符自定义标题格式，如 `{status}{title}-【{model}】`。可用占位符：
  - `{status}`：生成状态图标
  - `{title}`：对话标题
  - `{model}`：当前使用的模型名称
- **模型名称识别**：自动识别并可在标题中显示当前使用的模型（如"2.5 Pro"、"思考"、"自动"等）。

### ✨ 隐私模式 (Boss Key)

- **一键伪装**：开启后标签页标题显示为伪装文本（默认"Google"），隐藏真实对话内容。
- **快速切换**：双击面板标题可快速开启/关闭隐私模式，无需打开设置。

### ✨ 后台行为控制

- **桌面通知**：生成完成时发送系统通知。
- **自动窗口置顶**：生成完成时自动将浏览器窗口带回前台。

---

## 版本 1.7.3 (2025-12-14)

> **架构升级**：本版本将"锚点"与"阅读历史"彻底分离为两个独立系统，提供更清晰的功能边界和更智能的定位体验。

### ✨ 阅读历史与锚点分离

脚本现在拥有两套独立的位置记录系统，各司其职：

- **阅读历史 (Reading Progress)**：

  - **设计意图**：长期"阅读进度记忆"，支持跨刷新/跨会话恢复
  - **更新时机**：用户滚动时自动记录（节流 1 秒）
  - **存储方式**：持久化到 GM_storage
  - **恢复方式**：页面加载或切换会话时自动恢复

- **锚点 (Anchor)**：
  - **设计意图**：短期"返回点"，类似浏览器后退或 `git switch -`
  - **更新时机**：点击"顶部/底部"按钮或点击大纲项跳转时自动保存当前位置
  - **存储方式**：内存级，会话内有效，不持久化

### ✨ 双向锚点跳转

- **来回切换**：锚点按钮现在支持在两个位置间来回跳转，类似 `git switch -`
- **使用场景**：点击大纲跳到标题 → 点锚点按钮回到原位 → 再点锚点按钮回到标题 → 无限循环
- **更直观的提示**：锚点按钮提示文案改为"返回跳转前位置"

### 🔧 技术改进

- **滚动监听优化**：改为监听实际滚动容器（而非 window），确保各站点的滚动事件都能被正确捕获
- **初始状态修复**：锚点按钮在无锚点时正确显示置灰状态
- **回调解耦**：大纲跳转通过 `onJumpBefore` 回调触发锚点保存，保持模块间松耦合

---

## 版本 1.7.2 (2025-12-14)

> **智能升级**：本版本彻底重构了“锚点恢复”逻辑，引入了基于内容的精准定位与自动历史回溯，确保在任何场景下都能精准恢复阅读进度。

### ✨ 智能锚点系统 (Smart Anchor System)

- **精准内容定位 (Content-Based Anchoring)**：
  - 弃用了不稳定的纯像素定位，改用“唯一元素+偏移量”的算法。
  - 即使在懒加载或内容变化的情况下，也能精准定位到具体的对话气泡。
- **自动历史回溯 (Auto History Backtracking)**：
  - 当目标内容未加载时（如长对话的历史消息），脚本会自动向上滚动触发加载。
  - 支持多轮自动重试与回溯，直到找到目标锚点，彻底解决了“刷新后无法恢复高楼层进度”的痛点。
- **智能恢复策略**：
  - 初始化时自动尝试恢复。
  - SPA 路由变化时自动尝试恢复。
  - 页面刷新后自动尝试恢复。

### 🎨 体验优化

- **大纲配置升级**：
  - 标题优化为更简洁的“大纲设置”。
  - 新增 **1 天** 和 **3 天** 的自动清理选项（默认调整为 7 天）。
- **稳健性提升**：
  - 修复了脚本初始化时可能出现的构造函数报错。
  - 优化了滚动容器的获取逻辑，兼容各类动态加载场景。

---

## 版本 1.7.1 (2025-12-13)

> **体验优化**：本版本重点打磨了设置面板的交互体验，并增强了对模型自动化的支持。

### ✨ 支持全站点模型自动化锁定

- **覆盖全平台**：现在支持 Gemini 标准版、Gemini 企业版 (Business/Enterprise)、AI Studio 以及 Vertex AI 的模型自动锁定。
- **独立配置**：每个站点可独立配置是否开启锁定以及锁定的关键词（如 `3 Pro`）。
- **自动化执行**：进入页面时自动检测并切换到指定模型，减少重复操作。

### 🎨 设面板 UI 重构

- **可折叠收纳**：将“模型锁定”、“页面宽度”、“界面排版”重构为可折叠面板，界面更整洁。
- **逻辑重排**：优化了设置项的排列顺序，将常用设置置顶。
- **平滑动画**：为折叠/展开操作添加了优雅的动画效果。

---

## 版本 1.7.0 (2025-12-12)

> **里程碑更新**：本版本带来了全新的对话大纲功能、面板 UI 的全面优化以及更智能的页面适配。

### ✨ 核心功能：对话大纲系统

- **结构化大纲生成**：自动从 AI 回复中提取 H1-H6 标题结构，生成清晰的目录树。
- **智能缩进与折叠**：
  - 根据提取到的最高标题层级自动调整缩进，避免空白。
  - 支持一键展开/折叠全部节点。
  - 支持层级滑块（Slider），快速过滤显示至特定级别的标题。
- **快速跳转导航**：点击大纲项平滑滚动至对话位置，并伴有高亮闪烁提示，长对话浏览更轻松。
- **Tab 独立管理**：
  - 新增"📑 大纲"标签页，与提示词、设置页签并列。
  - 提供开关控制，不需要时可完全关闭大纲功能。

### 🎨 UI 与交互体验优化

- **面板高度智能化**：
  - 摒弃了固定的像素限制，面板高度现在智能适配屏幕（占用约 80% 视口高度）。
  - 内部滚动区域自适应，在大屏上可展示更多内容，小屏下自动回缩。
- **界面排版自定义**：
  - 新增 **Tab 排序功能**，用户可在设置中自由拖拽调整"提示词"、"大纲"、"设置"的显示顺序。
- **视觉细节打磨**：
  - 优化了面板的阴影、边框和圆角处理，使其更符合 Material Design 风格。
  - 统一了各模块的按钮样式和交互反馈。

### 🔧 页面适配与兼容性

- **Gemini Business 专属增强**：
  - 针对企业版（Shadow DOM）架构进行了深度适配，确保所有功能（包括大纲提取）完美运行。
  - 新增 **中文输入修复**：发送消息后自动插入零宽字符，解决企业版特有的中文输入首字母变英文的问题。
- **页面加宽重构**：
  - 重写了页面加宽逻辑，支持百分比（%）和像素（px）两种单位。
  - 修复了加宽模式下用户消息对齐问题，确保界面布局协调。
- **多站点支持**：底层架构升级为适配器模式，完美兼容 Gemini 标准版、Gemini 企业版.

### ⚙️ 其他改进

- **多语言系统**：完整支持简体中文、繁体中文和英语，根据浏览器语言自动切换。
- **配置持久化**：所有设置（开关、排序、宽度）均本地保存，刷新不丢失。

---

## 版本 1.6.0 (2025-12-10)

- ✨ **新功能**：Tab 切换架构（提示词 | 设置）
- ✨ **新功能**：设置面板（仅 Gemini Business）
  - 发送后自动修复中文输入开关
- 🌐 **国际化**：多语言支持（简中/繁中/英语）
- 🎨 **UI**：面板重命名为"Gemini 助手"

---

## 版本 1.5.0 (2025-12-09)

- ⚡️ **重构**：引入站点适配器模式 (Site Adapter Pattern)，大幅提升代码扩展性
- 🛠 **优化**：解耦特定站点逻辑，为未来支持更多 AI 平台奠定基础
- 修复页面加载后首次插入提示词时，多行文本只能插入首行

---

## 版本 1.4.0 (2025-12-08)

- 新增分类管理功能（重命名、删除）
- 新增拖动排序功能
- 新增复制提示词功能

---

## 版本 1.3.0 (2025-12-08)

- 优化悬浮条逻辑，发送后自动隐藏

---

## 版本 1.2.0 (2025-12-08)

- 新增快捷跳转按钮（顶部/底部）

---

## 版本 1.1.0 (2025-12-08)

- 支持 Gemini 企业版 (Shadow DOM 适配)
